<?xml version="1.0" encoding="UTF-8"?>
<AttributeResolver
        xmlns="urn:mace:shibboleth:2.0:resolver" 
        xmlns:resolver="urn:mace:shibboleth:2.0:resolver"
        xmlns:sec="urn:mace:shibboleth:2.0:security"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xmlns:oidcext="org.geant.idpextension.oidc.attribute.encoder"
        xsi:schemaLocation="urn:mace:shibboleth:2.0:resolver http://shibboleth.net/schema/idp/shibboleth-attribute-resolver.xsd
                            urn:mace:shibboleth:2.0:security http://shibboleth.net/schema/idp/shibboleth-security.xsd
                            org.geant.idpextension.oidc.attribute.encoder classpath:/schema/idp-oidc-extension-attribute-encoder.xsd
                            ">

   <!-- ========================================== -->
   <!--      Attribute Definitions                 -->
   <!-- ========================================== -->

<!-- OIDC Subject -->
<AttributeDefinition id="subject" xsi:type="Simple" >
   <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
   <AttributeEncoder xsi:type="oidcext:OIDCString" name="sub" />
</AttributeDefinition>

 <!-- Simple EDS attributes -->

 <!-- ePPN = uwNetID plus scope -->

    <AttributeDefinition id="ePPN" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonPrincipalName" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" friendlyName="eduPersonPrincipalName" />
    </AttributeDefinition>

 <!-- NIH saml1 ePPN = uwNetID@washington.edu -->

    <AttributeDefinition id="NIHePPN" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" scopeType="inline" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" friendlyName="eduPersonPrincipalName" scopeType="inline" />
    </AttributeDefinition>

  <!-- uwnetid = uwNetID (unscoped string) -->

    <AttributeDefinition id="uwNetID" xsi:type="Simple" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:uid" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.1" friendlyName="uid" />
    </AttributeDefinition>


 <!-- regid = uwRegID -->

    <AttributeDefinition id="uwRegID" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwRegID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwRegID" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.24" friendlyName="uwRegID" />
    </AttributeDefinition>


 <!-- cn -->

    <AttributeDefinition id="cn" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="cn" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:cn" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.3" friendlyName="cn" />
    </AttributeDefinition>

 <!-- preferred names -->

    <AttributeDefinition id="preferredFirst" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredFirst" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.47" friendlyName="preferredFirst" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="preferred_first" />
    </AttributeDefinition>

    <AttributeDefinition id="preferredMiddle" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredMiddle" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.48" friendlyName="preferredMiddle" />

    </AttributeDefinition>

    <AttributeDefinition id="preferredSurname" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredSurname" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.49" friendlyName="preferredSurname" />
    </AttributeDefinition>

 <!-- surname = uwPersonRegisteredSurname -->

    <AttributeDefinition id="surname" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredSurname" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:sn" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.4" friendlyName="surname" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="family_name" />
    </AttributeDefinition>

 <!-- homeDepartment = uwEmployeeHomeDepartment -->

    <AttributeDefinition id="homedept" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeHomeDepartment" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.11" friendlyName="homeDepartment" />
    </AttributeDefinition>

 <!-- title = uwEWPTitle1 -->

    <AttributeDefinition id="title" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPTitle1" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.12" friendlyName="title" />
    </AttributeDefinition>

 <!-- mailstop = uwEmployeeMailstop -->

    <AttributeDefinition id="mailstop" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeMailstop" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.18" friendlyName="mailstop" />
    </AttributeDefinition>

 <!-- phone = uwEWPPhone1 -->

    <AttributeDefinition id="phone" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPPhone1" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.20" friendlyName="phone" />
    </AttributeDefinition>

 <!--  name = displayName -->

    <AttributeDefinition id="displayName" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="displayName" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:displayName" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.16.840.1.113730.3.1.241" friendlyName="displayName" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="name" />
    </AttributeDefinition>

 <!-- givenName = uwPersonRegisteredFirstMiddle -->

    <AttributeDefinition id="givenName" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredFirstMiddle" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:givenName" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.42" friendlyName="givenName" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="given_name" />
    </AttributeDefinition>


 <!-- preferredFirst = uwPersonPreferredFirst -->

    <AttributeDefinition id="preferredFirst" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredFirst" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.47" friendlyName="preferredFirst" />
    </AttributeDefinition>

 <!-- preferredMiddle = uwPersonPreferredMiddle -->

    <AttributeDefinition id="preferredMiddle" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredMiddle" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.48" friendlyName="preferredMiddle" />
    </AttributeDefinition>

 <!-- preferredSurname = uwPersonPreferredSurname -->

    <AttributeDefinition id="preferredSurname" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredSurname" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.49" friendlyName="preferredSurname" />
    </AttributeDefinition>

 <!-- employeeNumber = uwEmployeeID -->

    <AttributeDefinition id="employeeNumber" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:employeeNumber" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.16.840.1.113730.3.1.3" friendlyName="employeeNumber" />
    </AttributeDefinition>


 <!-- studentNumber -->

    <AttributeDefinition id="uwStudentID" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwStudentID" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.21" friendlyName="uwStudentID" />
    </AttributeDefinition>

 <!-- student systemkey -->

    <AttributeDefinition id="uwStudentSystemKey" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentSystemKey" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwStudentSystemKey" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.20" friendlyName="uwStudentSystemKey" />
    </AttributeDefinition>

 <!-- affiliation = eduPersonAffiliation -->

    <AttributeDefinition id="affiliation" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.1" friendlyName="eduPersonAffiliation" />
    </AttributeDefinition>

 <!-- scopedAffiliation = eduPersonAffiliation -->

    <AttributeDefinition id="scopedAffiliation" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="personreg" attributeNames="eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonScopedAffiliation" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.9" friendlyName="eduPersonScopedAffiliation" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="scoped_affiliation" />
    </AttributeDefinition>



 <!-- Entitlements -->

   <!-- library entitlement: employee, student, or usr_kiosk -->


    <DataConnector  xsi:type="Static" id="entitlement_lib_dummy">
        <Attribute id="entitlement_lib">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_lib" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_lib_dummy" attributeNames="entitlement_lib"/>
        <InputAttributeDefinition ref="affiliation" />
        <InputAttributeDefinition ref="ePPN" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_lib.getValues().clear();
              var affs = affiliation.getValues();
              var eppn = ePPN.getValues();
              if ((affs!=null) && ((affs.indexOf('staff')>=0)||(affs.indexOf('student')>=0)||(affs.indexOf('faculty')>=0) ||
                  (eppn.indexOf('usr_kiosk')>=0))) { 
                     entitlement_lib.getValues().add('urn:mace:incommon:entitlement:common:1');
                     entitlement_lib.getValues().add('urn:mace:dir:entitlement:common-lib-terms');
              }
             ]]>
          </Script>
    </AttributeDefinition>

  <!-- webassign entitlement: course membership by sln -->

    <DataConnector  xsi:type="Static" id="entitlement_sln_dummy">
        <Attribute id="entitlement_sln">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_sln" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_sln_dummy" attributeNames="entitlement_sln"/>
        <InputAttributeDefinition ref="sln_courses" />
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_sln.getValues().clear();
              var ncrs = sln_courses.getValues().size();
              for (var i=0; i<ncrs; i++) {
                 var crs = sln_courses.getValues().get(i);
                 if (crs.startsWith("course")) {
                    var y = crs.substring(7,11);
                    var q = crs.substring(11,14);
                    var s = crs.substring(15);
                    entitlement_sln.getValues().add("urn:mace:washington.edu:courses:" + q + y + ":" + s);
                 }
              }
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.startsWith("urn:mace:washington.edu:groups:uw_course_")) {
                    var y = grp.substring(41,45);
                    var q = grp.substring(45,48);
                    var s = grp.substring(49);
                    var w = s.indexOf("_waitlist");
                    if (w>0) {
                       entitlement_sln.getValues().add("urn:mace:washington.edu:courses:" + q + y + ":" + s.substring(0,w));
                    }
                 }
              }
             ]]>
          </Script>

    </AttributeDefinition>

    <!-- e-academy entitlement -->

    <DataConnector  xsi:type="Static" id="entitlement_spss_dummy">
        <Attribute id="entitlement_spss">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_spss" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_spss_dummy" attributeNames="entitlement_spss"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_spss.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("uw_affiliation_graduate")) {
                    entitlement_spss.getValues().add("urn:mace:washington.edu:entitlement:spss");
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- gartner entitlement -->

    <DataConnector  xsi:type="Static" id="entitlement_gartner_dummy">
        <Attribute id="entitlement_gartner">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_gartner" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_gartner_dummy" attributeNames="entitlement_gartner"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_gartner.getValues().clear()
              var ngws = gws_groups.getValues().size();
              var egtp = 0;
              var ecore = 0;
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_licenses_gartner_gtp")) {
                    entitlement_gartner.getValues().add("UW-GTP");
                    egtp = 1;
                    break;
                 }
                 if (grp.equals("urn:mace:washington.edu:groups:u_licenses_gartner_core")) ecore = 1;
              }
              if (egtp==0 && ecore==1) entitlement_gartner.getValues().add("UW-Core");
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- DLT entitlements -->

    <DataConnector  xsi:type="Static" id="entitlement_dlt_a_dummy">
        <Attribute id="entitlement_dlt_a">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_dlt_a" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_dlt_a_dummy" attributeNames="entitlement_dlt_a"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_dlt_a.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_aws001_dlt_admins")) {
                    entitlement_dlt_a.getValues().add("urn:mace:incommon:washington.edu:edu-sa");
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- AWS roles -->
    <DataConnector  xsi:type="Static" id="awsrole_dummy">
        <Attribute id="awsrole">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="awsrole" xsi:type="ScriptedAttribute" activationConditionRef="uw.GetsAwsRole" >
        <InputDataConnector ref="awsrole_dummy" attributeNames="awsrole"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML2String" name="https://aws.amazon.com/SAML/Attributes/Role" friendlyName="Role" />

          <!-- scan groups for AWS roles -->
          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("net.shibboleth.idp.attribute");
              awsrole.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.startsWith("urn:mace:washington.edu:groups:u_weblogin_aws_")) {
                    var ar = grp.substring(46);
                    var u = ar.indexOf("_");
                    if (u>0) {
                       var aid = ar.substring(0,u);
                       var role = ar.substring(u+1);
                       awsrole.getValues().add("arn:aws:iam::"+aid+":role/"+role+",arn:aws:iam::"+aid+":saml-provider/%{idp.uw.awsEntityId}");
                    }
                 }
              }
              logger.info("aws roles = {}", awsrole.getValues());
             ]]>
          </Script>

    </AttributeDefinition>

    <AttributeDefinition id="awsname" xsi:type="Scoped" scope="washington.edu" activationConditionRef="uw.GetsAwsRole" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML2ScopedString" 
            name="https://aws.amazon.com/SAML/Attributes/RoleSessionName" friendlyName="RoleSessionName" scopeType="inline" />
    </AttributeDefinition>

    <AttributeDefinition id="awssession" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="awstwelve" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="https://aws.amazon.com/SAML/Attributes/SessionDuration" friendlyName="SessionDuration" />
    </AttributeDefinition>

    <DataConnector  xsi:type="Static" id="entitlement_dlt_u_dummy">
        <Attribute id="entitlement_dlt_u">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_dlt_u" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_dlt_u_dummy" attributeNames="entitlement_dlt_u"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_dlt_u.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_aws001_dlt_users")) {
                    entitlement_dlt_u.getValues().add("urn:mace:incommon:washington.edu:edu-req");
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>





 <!-- NameIDs -->


 <!-- Nameids and persistent ids as attributes -->

 <!-- ePTID = eduPersonTargetedID (as scoped attribute) -->

    <AttributeDefinition id="ePTID" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>


 <!-- NIHePTID = eduPersonTargetedID (as inline scoped attribute) -->

    <AttributeDefinition id="NIHePTID" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" scopeType="inline"/>
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>



 <!-- attributePersistentID = eduPersonTargetedID (as SAML2 attribute) -->

    <AttributeDefinition id="attributePersistentID" xsi:type="SAML2NameID" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1XMLObject" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" />
        <AttributeEncoder xsi:type="SAML2XMLObject" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>


 <!-- NameID source attributes - these define the needed attribute -->

    <AttributeDefinition id="nameIDPersistentID" xsi:type="Simple" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
    </AttributeDefinition>

    <AttributeDefinition id="eppnNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="ePPN" />
    </AttributeDefinition>

    <AttributeDefinition id="idNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwNetID" />
    </AttributeDefinition>

    <AttributeDefinition id="uwEduEmailNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwEduEmail" />
    </AttributeDefinition>

 <!-- email -->
    <AttributeDefinition id="student_email" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwSWPEmail" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:mail" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
    </AttributeDefinition>

    <AttributeDefinition id="staff_email" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPEmail1" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:mail" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
    </AttributeDefinition>

    <!-- computed email -->

    <DataConnector  xsi:type="Static" id="email_dummy">
        <Attribute id="email">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="email" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="email_dummy" attributeNames="email"/>
        <InputAttributeDefinition ref="staff_email" />
        <InputAttributeDefinition ref="student_email" />
        <InputAttributeDefinition ref="uwNetID" />

        <AttributeEncoder xsi:type="SAML1String" 
            name="urn:mace:dir:attribute-def:mail" />

        <AttributeEncoder xsi:type="SAML2String" 
            name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
<AttributeEncoder xsi:type="oidcext:OIDCString" name="email" />

          <Script>
           <![CDATA[
              email.getValues().clear();
              var m;
              if ( staff_email.getValues().size()>0 ) m = staff_email.getValues().get(0);
              else if ( student_email.getValues().size()>0 ) m = student_email.getValues().get(0);
              else m = uwNetID.getValues().get(0) + "@uw.edu";
              email.getValues().add(m);
             ]]>
          </Script>
    </AttributeDefinition>

  <!-- uw.edu email -->

    <AttributeDefinition id="uwEduEmail" xsi:type="Template" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID"/>
        <AttributeEncoder xsi:type="SAML1String" 
            name="urn:mace:washington.edu:dir:attribute-def:uwEduEmail" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="urn:oid:1.2.840.113994.200.45" friendlyName="uwEduEmail" />

          <Template>
           <![CDATA[
                 ${uwNetID}@uw.edu
             ]]>
          </Template>

    </AttributeDefinition>



  <!-- GWS memberships -->

    <AttributeDefinition id="gws_groups" xsi:type="Template" >
        <InputDataConnector ref="gws" attributeNames="memberOf"/>

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:isMemberOf" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.5.1.1" friendlyName="isMemberOf" />
        <resolver:AttributeEncoder xsi:type="oidcext:OIDCString" name="edumember_is_member_of" />

          <Template>
           <![CDATA[
                 urn:mace:washington.edu:groups:${memberOf}
             ]]>
          </Template>

    </AttributeDefinition>

 <!-- Course memberships by SLN - this is just for other attributes, not delivered directly -->

    <AttributeDefinition id="sln_courses" xsi:type="Simple" >
        <InputDataConnector ref="courses" attributeNames="memberOf" />
    </AttributeDefinition>


 <!-- static silver assurance -->

    <AttributeDefinition id="assurance" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="eduPersonAssurance" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonAssurance" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.11" friendlyName="eduPersonAssurance" />
    </AttributeDefinition>

 <!-- NSC specials -->
    <AttributeDefinition id="nsc_pid" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentID" />
        <AttributeEncoder xsi:type="SAML1String" 
            namespace="http://www.pesc.org/standards/attrs" name="SchoolAssignedPersonID" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="http://www.pesc.org/standards/attrs/SchoolAssignedPersonID" friendlyName="HTTP_SchoolAssignedPersonID" />
    </AttributeDefinition>

    <AttributeDefinition id="nsc_opeid" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="nscOPEID" />
        <AttributeEncoder xsi:type="SAML1String" namespace="http://www.pesc.org/standards/attrs" name="OPEID" />
        <AttributeEncoder xsi:type="SAML2String" name="http://www.pesc.org/standards/attrs/OPEID " friendlyName="HTTP_OPEID" />
    </AttributeDefinition>

 <!-- slack idiot specials -->
    <AttributeDefinition id="slack_email" xsi:type="Simple" >
        <InputAttributeDefinition ref="email" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:0.9.2342.19200300.100.1.3" name="User.Email" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_user" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwNetID" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:0.9.2342.19200300.100.1.1" name="User.Username" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_fname" xsi:type="Simple" >
        <InputAttributeDefinition ref="preferredFirst" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:2.5.4.42" name="first_name" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_lname" xsi:type="Simple" >
        <InputAttributeDefinition ref="preferredSurname" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:2.5.4.4" name="last_name" />
    </AttributeDefinition>


    <!-- ========================================== -->
    <!--      Data Connectors                       -->
    <!-- ========================================== -->


    <!-- Get uwNetID from login -->
    <DataConnector id="loginNetid" xsi:type="ScriptedDataConnector">
        <Script><![CDATA[
           logger = Java.type("org.slf4j.LoggerFactory").getLogger("net.shibboleth.idp.attribute");
           logger.info("==== scripted enter ====");
    
           IdPAttribute = Java.type("net.shibboleth.idp.attribute.IdPAttribute");
           StringAttributeValue = Java.type("net.shibboleth.idp.attribute.StringAttributeValue");
           HashSet = Java.type("java.util.HashSet");

           logger.info("username = " + resolutionContext.getPrincipal());
           attr = new IdPAttribute("uwNetID");
           set = new HashSet(1);
           set.add(new StringAttributeValue(resolutionContext.getPrincipal()));
           attr.setValues(set);
           connectorResults.add(attr);
           logger.info("==== scripted exit ====");
        ]]></Script>
    </DataConnector>



    <!-- Static Connector Values-->
    <DataConnector id="staticAttributes" xsi:type="Static" >
        <Attribute id="eduPersonAssurance">
            <Value>http://incommonfederation.org/assurance/silver-test</Value>
        </Attribute>
        <Attribute id="nscOPEID">
            <Value>00379800</Value>
        </Attribute>
        <Attribute id="awsfoxadmin">
            <Value>arn:aws:iam::575779389826:role/UW_dev.admin,arn:aws:iam::575779389826:saml-provider/UW_IdP_dev</Value>
        </Attribute>
        <Attribute id="awstwelve">
            <Value>43200</Value>
        </Attribute>
    </DataConnector>

    <!-- EDS ldap service -->
<!--
           ldapURL="ldap://eds.u.washington.edu:389"
           ldapURL="ldap://seneca22.s.uw.edu:389 ldap://seneca21.s.uw.edu:389 ldap://seneca23.s.uw.edu:389"
  -->

    <DataConnector id="personreg" xsi:type="LDAPDirectory" 
{% if location == 'uwtc' %}
           ldapURL="ldap://seneca22.s.uw.edu:389 ldap://seneca21.s.uw.edu:389 ldap://seneca23.s.uw.edu:389"
{% elif location == 'ads' %}
           ldapURL="ldap://seneca21.s.uw.edu:389 ldap://seneca22.s.uw.edu:389 ldap://seneca23.s.uw.edu:389"
{% else %}
           ldapURL="ldap://seneca23.s.uw.edu:389 ldap://seneca22.s.uw.edu:389 ldap://seneca21.s.uw.edu:389"
{% endif %}
           baseDN="dc=washington,dc=edu"
           principal="cn=idp.u.washington.edu"
           maxResultSize="10"
           searchTimeLimit="P0Y0M0DT0H0M10.000S"
           authenticationType="EXTERNAL"
           useStartTLS="true"
           connectTimeout="PT3S"
           responseTimeout="PT5S"
           trustFile="/data/local/idp-3.4/credentials/uw-incommon-ca.crt"
           authCert="/data/local/idp-3.4/credentials/idp-uw.crt"
           authKey="/data/local/idp-3.4/credentials/idp-uw.key"
           propagateResolutionExceptions="false"
           >
        <FilterTemplate>
            <![CDATA[
               (uwNetID=${resolutionContext.principal})
            ]]>
        </FilterTemplate>
        
        <ConnectionPool
            minPoolSize="0"
            maxPoolSize="6"
            blockWaitTime="PT10S"
            expirationTime="PT10M"
            validatePeriodically="false"
            validateTimerPeriod="PT15M"
            validateDN="dc=washington,dc=edu"
            validateFilter="(ou=People,dc=personregistry)"
            failFastInitialize="false" />

    </DataConnector>



 <!-- tgtid (uw method) = eduPersonTargetedID -->

    <!-- Static Connector until idpv3 r/w  bug fixed -->
    <DataConnector id="tgtid2static" xsi:type="Static" >
        <Attribute id="eduPersonTargetedID">
            <Value>1234567890</Value>
        </Attribute>
    </DataConnector>


    <DataConnector id="tgtid2" xsi:type="RelationalDatabase" 
         readOnlyConnection="false"
         queryTimeout="PT5S"
         propagateResolutionExceptions="false"
         >
        <InputAttributeDefinition ref="uwRegID" />

        <BeanManagedConnection>EptidDataConnector</BeanManagedConnection>

        <QueryTemplate>
            <![CDATA[
                select tid2('${uwRegID.get(0)}', '${requestContext.attributeRecipientID}') as tid
            ]]>
        </QueryTemplate>

        <Column columnName="tid" attributeID="eduPersonTargetedID" />
    </DataConnector>


   <!-- GWS group memberships -->

<DataConnector id="gws" xsi:type="HTTP" 
        httpClientRef="uw.HttpClient"
        httpClientSecurityParametersRef="uw.GwsSecurity" 
           propagateResolutionExceptions="false"
        >
    <URLTemplate>
        <![CDATA[
        https://groups.uw.edu/group_sws/v3/search?member=${resolutionContext.principal}&type=effective&junk=1
        ]]>
    </URLTemplate>
 
    <ResponseMapping>
        <ScriptFile>%{idp.home}/conf/http-gws.js</ScriptFile>
    </ResponseMapping>
        <ResultCache expireAfterWrite="PT5M"/>
 
</DataConnector>

<DataConnector id="courses" xsi:type="HTTP" 
        httpClientRef="uw.HttpClient"
        httpClientSecurityParametersRef="uw.GwsSecurity" 
           propagateResolutionExceptions="false"
        >
    <URLTemplate>
        <![CDATA[
        https://groups.uw.edu/group_sws/v3/search?stem=course&member=${resolutionContext.principal}&view=sln
        ]]>
    </URLTemplate>
 
    <ResponseMapping>
        <ScriptFile>%{idp.home}/conf/http-gws.js</ScriptFile>
    </ResponseMapping>
        <ResultCache expireAfterWrite="PT5M"/>
 
</DataConnector>

</AttributeResolver>
