<?xml version="1.0" encoding="UTF-8"?>
<AttributeResolver
        xmlns="urn:mace:shibboleth:2.0:resolver" 
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xmlns:oidc="urn:mace:shibboleth:2.0:resolver:oidc"
        xsi:schemaLocation="urn:mace:shibboleth:2.0:resolver http://shibboleth.net/schema/idp/shibboleth-attribute-resolver.xsd
                            urn:mace:shibboleth:2.0:resolver:oidc http://shibboleth.net/schema/oidc/shibboleth-attribute-encoder-oidc.xsd">

 <!-- ========================================== -->
 <!--      Attribute Definitions                 -->
 <!-- ========================================== -->

 <!-- OIDC Subject -->

 <AttributeDefinition id="subject-public" xsi:type="Simple" 
            activationConditionRef="shibboleth.oidc.Conditions.PublicRequired">
    <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
    <AttributeEncoder xsi:type="oidc:OIDCString" name="sub" />
 </AttributeDefinition>

 <AttributeDefinition id="subject-pairwise" xsi:type="Simple" 
	 activationConditionRef="shibboleth.oidc.Conditions.PairwiseRequired">
     <InputDataConnector ref="computedSubjectId" attributeNames="subjectId"/>
     <AttributeEncoder xsi:type="oidc:OIDCString" name="sub" />
 </AttributeDefinition>

 <!-- Simple EDS attributes -->

 <!-- ePPN = uwNetID plus scope -->

    <AttributeDefinition id="ePPN" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonPrincipalName" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" friendlyName="eduPersonPrincipalName" />
    </AttributeDefinition>

 <!-- NIH saml1 ePPN = uwNetID@washington.edu -->

    <AttributeDefinition id="NIHePPN" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" scopeType="inline" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.6" friendlyName="eduPersonPrincipalName" scopeType="inline" />
    </AttributeDefinition>

  <!-- uwnetid = uwNetID (unscoped string) -->

    <AttributeDefinition id="uwNetID" xsi:type="Simple" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:uid" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.1" friendlyName="uid" />
    </AttributeDefinition>

    <!-- Shibboleth 4.2 requires a uid attribute defined and will not start without it. This is not used except to make Shibboleth happy. -->
    <AttributeDefinition id="uid" xsi:type="Simple" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:uid" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.1" friendlyName="uid" />
    </AttributeDefinition>

 <!-- regid = uwRegID -->

    <AttributeDefinition id="uwRegID" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwRegID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwRegID" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.24" friendlyName="uwRegID" />
    </AttributeDefinition>


    <AttributeDefinition id="cnDummy" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredSurname" />
    </AttributeDefinition>

    <AttributeDefinition id="cn" xsi:type="ScriptedAttribute" >
        <InputAttributeDefinition ref="cnDummy" />
        <InputAttributeDefinition ref="preferredFirst" />
        <InputAttributeDefinition ref="preferredMiddle" />
        <InputAttributeDefinition ref="preferredSurname" />
        <InputAttributeDefinition ref="uwNetID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:cn" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.3" friendlyName="cn" />

          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("edu.washington.shibboleth");
              cn.getValues().clear();
              if (preferredFirst.getValues().size()>0) {
                   pcn = preferredFirst.getValues().get(0);
                   if (preferredMiddle.getValues().size()>0) pcn = pcn + " " + preferredMiddle.getValues().get(0);
                   if (preferredSurname.getValues().size()>0) pcn = pcn + " " + preferredSurname.getValues().get(0);
                   logger.debug("cn is preferred: {}", pcn);
                   cn.getValues().add(pcn);
              } else {
                   logger.debug("cn is registered");
                   if (cnDummy.getValues().size()>0) {
                       cn.getValues().add(cnDummy.getValues().get(0));
                   } else {
                       if (uwNetID.getValues().length>0) logger.info("no cn: " + uwNetID.getValues()[0]);
                   }
              }
             ]]>
          </Script>

    </AttributeDefinition>






 <!-- preferred names -->

    <AttributeDefinition id="preferredFirst" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredFirst" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.47" friendlyName="preferredFirst" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="preferred_first" />
    </AttributeDefinition>

    <AttributeDefinition id="preferredMiddle" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredMiddle" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.48" friendlyName="preferredMiddle" />

    </AttributeDefinition>

    <AttributeDefinition id="preferredSurname" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPreferredSurname" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.49" friendlyName="preferredSurname" />
    </AttributeDefinition>

 <!-- surname = preferred or uwPersonRegisteredSurname -->

    <AttributeDefinition id="surnameDummy" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredSurname" />
    </AttributeDefinition>

    <AttributeDefinition id="surname" xsi:type="ScriptedAttribute" >
        <InputAttributeDefinition ref="surnameDummy" />
        <InputAttributeDefinition ref="preferredSurname" />
        <InputAttributeDefinition ref="uwNetID" />
        <InputAttributeDefinition ref="uwRegID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:sn" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.4" friendlyName="surname" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="family_name" />

          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("edu.washington.shibboleth");
              surname.getValues().clear();
              if (preferredSurname.getValues().size()>0) {
                   logger.debug("RES: surname is preferred");
                   surname.getValues().add(preferredSurname.getValues().get(0));
              } else {
                   logger.debug("RES: surname, is registered");
                   if (surnameDummy.getValues().size()>0) {
                       surname.getValues().add(surnameDummy.getValues().get(0));
                   } else {
                       if (uwNetID.getValues().length>0) logger.info("no surname: " + uwNetID.getValues()[0]);
                   }
              }
             ]]>
          </Script>

    </AttributeDefinition>

    <AttributeDefinition id="alt1_surname" xsi:type="Simple" >
        <InputAttributeDefinition ref="surname" />
        <AttributeEncoder xsi:type="SAML2String" name="Surname" />
    </AttributeDefinition>

    <AttributeDefinition id="alt2_surname" xsi:type="Simple" >
        <InputAttributeDefinition ref="surname" />
        <AttributeEncoder xsi:type="SAML2String" name="LastName" />
    </AttributeDefinition>

    <AttributeDefinition id="alt3_surname" xsi:type="Simple" >
        <InputAttributeDefinition ref="surname" />
        <AttributeEncoder xsi:type="SAML2String" name="last_name" />
    </AttributeDefinition>

 <!-- homeDepartment = uwEmployeeHomeDepartment -->

    <AttributeDefinition id="homedept" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeHomeDepartment" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.11" friendlyName="homeDepartment" />
    </AttributeDefinition>

 <!-- title = uwEWPTitle1 -->

    <AttributeDefinition id="title" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPTitle1" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.12" friendlyName="title" />
    </AttributeDefinition>

 <!-- mailstop = uwEmployeeMailstop -->

    <AttributeDefinition id="mailstop" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeMailstop" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.18" friendlyName="mailstop" />
    </AttributeDefinition>

 <!-- phone = uwEWPPhone1 -->

    <AttributeDefinition id="phone" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPPhone1" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.20" friendlyName="phone" />
    </AttributeDefinition>

 <!--  name = displayName -->

    <AttributeDefinition id="displayName" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="displayName" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:displayName" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.16.840.1.113730.3.1.241" friendlyName="displayName" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="name" />
    </AttributeDefinition>

 <!-- givenName = preferred or uwPersonRegisteredFirstMiddle -->

    <AttributeDefinition id="givenNameDummy" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredFirstMiddle" />
    </AttributeDefinition>

    <AttributeDefinition id="givenName" xsi:type="ScriptedAttribute" >
        <InputAttributeDefinition ref="givenNameDummy" />
        <InputAttributeDefinition ref="preferredFirst" />
        <InputAttributeDefinition ref="preferredMiddle" />
        <InputAttributeDefinition ref="uwNetID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:givenName" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.5.4.42" friendlyName="givenName" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="given_name" />

          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("edu.washington.shibboleth");
              givenName.getValues().clear();
              if (preferredFirst.getValues().size()>0) {
                   gn = preferredFirst.getValues().get(0);
                   if (preferredMiddle.getValues().size()>0) gn = gn + " " + preferredMiddle.getValues().get(0);
                   logger.debug("RES: given is preferred: {}", gn);
                   givenName.getValues().add(gn);
              } else {
                   logger.debug("RES: given is registered");
                   if (givenNameDummy.getValues().size()>0) {
                       givenName.getValues().add(givenNameDummy.getValues().get(0));
                   } else {
                       if (uwNetID.getValues().length>0) logger.info("no given: " + uwNetID.getValues()[0]);
                   }
              }
             ]]>
          </Script>
    </AttributeDefinition>

    <AttributeDefinition id="alt1_givenName" xsi:type="Simple" >
        <InputAttributeDefinition ref="givenName" />
        <AttributeEncoder xsi:type="SAML2String" name="GivenName" />
    </AttributeDefinition>

    <AttributeDefinition id="alt2_givenName" xsi:type="Simple" >
        <InputAttributeDefinition ref="givenName" />
        <AttributeEncoder xsi:type="SAML2String" name="FirstName" />
    </AttributeDefinition>

    <AttributeDefinition id="alt3_givenName" xsi:type="Simple" >
        <InputAttributeDefinition ref="givenName" />
        <AttributeEncoder xsi:type="SAML2String" name="first_name" />
    </AttributeDefinition>

 <!--  name = registered given name  -->

    <AttributeDefinition id="registeredGivenName" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredFirstMiddle" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.32" friendlyName="registeredGivenName" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="registered_given_name" />
    </AttributeDefinition>

 <!--  name = registered surname  -->

    <AttributeDefinition id="registeredSurname" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonRegisteredSurname" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.31" friendlyName="registeredSurname" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="registered_surname" />
    </AttributeDefinition>

 <!--  name = UW pronouns -->

    <AttributeDefinition id="uwPronouns" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwPersonPronoun" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.51" friendlyName="uwPronouns" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="uw_pronouns" />
    </AttributeDefinition>

 <!--  name = display name and pronouns -->

    <AttributeDefinition id="displayNameAndPronouns" xsi:type="ScriptedAttribute" >
        <InputAttributeDefinition ref="displayName" />
        <InputAttributeDefinition ref="uwPronouns" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.52" friendlyName="displayNameAndPronouns" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="display_name_and_pronouns" />

          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("edu.washington.shibboleth");
              displayNameAndPronouns.getValues().clear(); // just in case...
              if (displayName.getValues().size() > 0) {
                  if (uwPronouns.getValues().size() > 0) {
                       logger.debug("RES: non-empty uwPronouns found: {}", uwPronouns.getValues());
                       displayNameAndPronouns.getValues().add(displayName.getValues().get(0) + " (" + uwPronouns.getValues().get(0) + ")");
                  } else {
                       logger.debug("RES: uwPronouns is empty");
                       displayNameAndPronouns.getValues().add(displayName.getValues().get(0));
                  }
                  logger.debug("RES: displayNameAndPronouns: {}", displayNameAndPronouns.getValues().get(0));
              } else {
                  logger.debug("RES: displayNameAndPronouns: no displayName");
              }
             ]]>
          </Script>

    </AttributeDefinition>

 <!-- employeeNumber = uwEmployeeID -->

    <AttributeDefinition id="employeeNumber" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEmployeeID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:employeeNumber" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:2.16.840.1.113730.3.1.3" friendlyName="employeeNumber" />
    </AttributeDefinition>


 <!-- studentNumber -->

    <AttributeDefinition id="uwStudentID" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentID" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwStudentID" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.21" friendlyName="uwStudentID" />
    </AttributeDefinition>

 <!-- student systemkey -->

    <AttributeDefinition id="uwStudentSystemKey" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentSystemKey" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:washington.edu:dir:attribute-def:uwStudentSystemKey" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.2.840.113994.200.20" friendlyName="uwStudentSystemKey" />
    </AttributeDefinition>

 <!-- affiliation = eduPersonAffiliation -->

    <AttributeDefinition id="affiliation" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.1" friendlyName="eduPersonAffiliation" />
    </AttributeDefinition>

 <!-- scopedAffiliation = eduPersonAffiliation -->

    <AttributeDefinition id="scopedAffiliation" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="personreg" attributeNames="eduPersonAffiliation" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonScopedAffiliation" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.9" friendlyName="eduPersonScopedAffiliation" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="scoped_affiliation" />
    </AttributeDefinition>



 <!-- Entitlements -->

   <!-- library entitlement: employee, student, or usr_kiosk -->


    <DataConnector  xsi:type="Static" id="entitlement_lib_dummy">
        <Attribute id="entitlement_lib">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_lib" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_lib_dummy" attributeNames="entitlement_lib"/>
        <InputAttributeDefinition ref="affiliation" />
        <InputAttributeDefinition ref="ePPN" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_lib.getValues().clear();
              var affs = affiliation.getValues();
              var eppn = ePPN.getValues();
              if ((affs!=null) && ((affs.indexOf('staff')>=0)||(affs.indexOf('student')>=0)||(affs.indexOf('faculty')>=0) ||
                  (eppn.indexOf('usr_kiosk')>=0))) { 
                     entitlement_lib.getValues().add('urn:mace:incommon:entitlement:common:1');
                     entitlement_lib.getValues().add('urn:mace:dir:entitlement:common-lib-terms');
              }
             ]]>
          </Script>
    </AttributeDefinition>

  <!-- webassign entitlement: course membership by sln -->

    <DataConnector  xsi:type="Static" id="entitlement_sln_dummy">
        <Attribute id="entitlement_sln">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_sln" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_sln_dummy" attributeNames="entitlement_sln"/>
        <InputAttributeDefinition ref="sln_courses" />
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_sln.getValues().clear();
              var ncrs = sln_courses.getValues().size();
              for (var i=0; i<ncrs; i++) {
                 var crs = sln_courses.getValues().get(i);
                 if (crs.startsWith("course") && crs.length()>15) {
                    var y = crs.substring(7,11);
                    var q = crs.substring(11,14);
                    var s = crs.substring(15);
                    entitlement_sln.getValues().add("urn:mace:washington.edu:courses:" + q + y + ":" + s);
                 }
              }
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.startsWith("urn:mace:washington.edu:groups:uw_course_") && grp.length()>49) {
                    var y = grp.substring(41,45);
                    var q = grp.substring(45,48);
                    var s = grp.substring(49);
                    var w = s.indexOf("_waitlist");
                    if (w>0) {
                       entitlement_sln.getValues().add("urn:mace:washington.edu:courses:" + q + y + ":" + s.substring(0,w));
                    }
                 }
              }
             ]]>
          </Script>

    </AttributeDefinition>

    <!-- e-academy entitlement -->

    <DataConnector  xsi:type="Static" id="entitlement_spss_dummy">
        <Attribute id="entitlement_spss">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_spss" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_spss_dummy" attributeNames="entitlement_spss"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_spss.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("uw_affiliation_graduate")) {
                    entitlement_spss.getValues().add("urn:mace:washington.edu:entitlement:spss");
                    break;
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- gartner entitlement -->

    <DataConnector  xsi:type="Static" id="entitlement_gartner_dummy">
        <Attribute id="entitlement_gartner">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_gartner" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_gartner_dummy" attributeNames="entitlement_gartner"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_gartner.getValues().clear()
              var ngws = gws_groups.getValues().size();
              var egtp = 0;
              var ecore = 0;
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_licenses_gartner_gtp")) {
                    entitlement_gartner.getValues().add("UW-GTP");
                    egtp = 1;
                    break;
                 }
                 if (grp.equals("urn:mace:washington.edu:groups:u_licenses_gartner_core")) ecore = 1;
              }
              if (egtp==0 && ecore==1) entitlement_gartner.getValues().add("UW-Core");
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- DLT entitlements -->

    <DataConnector  xsi:type="Static" id="entitlement_dlt_a_dummy">
        <Attribute id="entitlement_dlt_a">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_dlt_a" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_dlt_a_dummy" attributeNames="entitlement_dlt_a"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_dlt_a.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_aws001_dlt_admins")) {
                    entitlement_dlt_a.getValues().add("urn:mace:incommon:washington.edu:edu-sa");
                    break;
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>

    <!-- AWS roles -->
    <DataConnector  xsi:type="Static" id="awsrole_dummy">
        <Attribute id="awsrole">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="awsrole" xsi:type="ScriptedAttribute" activationConditionRef="uw.GetsAwsRole" >
        <InputDataConnector ref="awsrole_dummy" attributeNames="awsrole"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML2String" name="https://aws.amazon.com/SAML/Attributes/Role" friendlyName="Role" />

          <!-- scan groups for AWS roles -->
          <Script>
           <![CDATA[
              logger = Java.type("org.slf4j.LoggerFactory").getLogger("edu.washington.shibboleth");
              awsrole.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.startsWith("urn:mace:washington.edu:groups:u_weblogin_aws_") && grp.length()>46) {
                    var ar = grp.substring(46);
                    var u = ar.indexOf("_");
                    if (u>0) {
                       var aid = ar.substring(0,u);
                       var role = ar.substring(u+1);
                       awsrole.getValues().add("arn:aws:iam::"+aid+":role/"+role+",arn:aws:iam::"+aid+":saml-provider/%{idp.uw.awsEntityId}");
                    }
                 }
              }
              logger.info("aws roles = {}", awsrole.getValues());
             ]]>
          </Script>

    </AttributeDefinition>

    <AttributeDefinition id="awsname" xsi:type="Scoped" scope="washington.edu" activationConditionRef="uw.GetsAwsRole" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID" />
        <AttributeEncoder xsi:type="SAML2ScopedString" 
            name="https://aws.amazon.com/SAML/Attributes/RoleSessionName" friendlyName="RoleSessionName" scopeType="inline" />
    </AttributeDefinition>

    <AttributeDefinition id="awssession" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="awstwelve" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="https://aws.amazon.com/SAML/Attributes/SessionDuration" friendlyName="SessionDuration" />
    </AttributeDefinition>

    <DataConnector  xsi:type="Static" id="entitlement_dlt_u_dummy">
        <Attribute id="entitlement_dlt_u">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="entitlement_dlt_u" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="entitlement_dlt_u_dummy" attributeNames="entitlement_dlt_u"/>
        <InputAttributeDefinition ref="gws_groups" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonEntitlement" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.7" friendlyName="eduPersonEntitlement" />

          <Script>
           <![CDATA[
              entitlement_dlt_u.getValues().clear();
              var ngws = gws_groups.getValues().size();
              for (var i=0; i<ngws; i++) {
                 var grp = gws_groups.getValues().get(i);
                 if (grp.equals("urn:mace:washington.edu:groups:u_aws001_dlt_users")) {
                    entitlement_dlt_u.getValues().add("urn:mace:incommon:washington.edu:edu-req");
                    break;
                 }
              }
             ]]>
          </Script>
    </AttributeDefinition>





 <!-- NameIDs -->


 <!-- Nameids and persistent ids as attributes -->

 <!-- ePTID = eduPersonTargetedID (as scoped attribute) -->

    <AttributeDefinition id="ePTID" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:mace:dir:attribute-def:eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>


 <!-- NIHePTID = eduPersonTargetedID (as inline scoped attribute) -->

    <AttributeDefinition id="NIHePTID" xsi:type="Scoped" scope="washington.edu" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" scopeType="inline"/>
        <AttributeEncoder xsi:type="SAML2ScopedString" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>



 <!-- attributePersistentID = eduPersonTargetedID (as SAML2 attribute) -->

    <AttributeDefinition id="attributePersistentID" xsi:type="SAML2NameID" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
        <AttributeEncoder xsi:type="SAML1XMLObject" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" />
        <AttributeEncoder xsi:type="SAML2XMLObject" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10" friendlyName="eduPersonTargetedID" />
    </AttributeDefinition>


 <!-- NameID source attributes - these define the needed attribute -->

    <AttributeDefinition id="nameIDPersistentID" xsi:type="Simple" >
        <InputDataConnector ref="tgtid2" attributeNames="eduPersonTargetedID" />
    </AttributeDefinition>

    <AttributeDefinition id="eppnNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="ePPN" />
    </AttributeDefinition>

    <AttributeDefinition id="idNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwNetID" />
    </AttributeDefinition>

    <AttributeDefinition id="uwEduEmailNameId" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwEduEmail" />
    </AttributeDefinition>

 <!-- email -->
    <AttributeDefinition id="student_email" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwSWPEmail" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:mail" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
    </AttributeDefinition>

    <AttributeDefinition id="staff_email" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwEWPEmail1" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:mail" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
    </AttributeDefinition>

    <!-- computed email -->

    <DataConnector  xsi:type="Static" id="email_dummy">
        <Attribute id="email">
            <Value>dummy</Value>
        </Attribute>
    </DataConnector>

    <AttributeDefinition id="email" xsi:type="ScriptedAttribute" >
        <InputDataConnector ref="email_dummy" attributeNames="email"/>
        <InputAttributeDefinition ref="staff_email" />
        <InputAttributeDefinition ref="student_email" />
        <InputAttributeDefinition ref="uwNetID" />

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:mail" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.3" friendlyName="mail" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="email" />

          <Script>
           <![CDATA[
              email.getValues().clear();
              var m;
              if ( staff_email.getValues().size()>0 ) m = staff_email.getValues().get(0);
              else if ( student_email.getValues().size()>0 ) m = student_email.getValues().get(0);
              else if ( uwNetID.getValues().size()>0 ) m = uwNetID.getValues().get(0) + "@uw.edu";
              else m = "";
              email.getValues().add(m);
             ]]>
          </Script>
    </AttributeDefinition>

    <AttributeDefinition id="alt1_email" xsi:type="Simple" >
        <InputAttributeDefinition ref="email" />
        <AttributeEncoder xsi:type="SAML2String" name="EmailAddress" />
    </AttributeDefinition>

  <!-- uw.edu email -->

    <AttributeDefinition id="uwEduEmail" xsi:type="Template" >
        <InputDataConnector ref="loginNetid" attributeNames="uwNetID"/>
        <AttributeEncoder xsi:type="SAML1String" 
            name="urn:mace:washington.edu:dir:attribute-def:uwEduEmail" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="urn:oid:1.2.840.113994.200.45" friendlyName="uwEduEmail" />

          <Template>
           <![CDATA[
                 ${uwNetID}@uw.edu
             ]]>
          </Template>

    </AttributeDefinition>



  <!-- GWS memberships -->

    <AttributeDefinition id="gws_groups" xsi:type="Template" >
        <InputDataConnector ref="gws" attributeNames="memberOf"/>

        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:isMemberOf" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.5.1.1" friendlyName="isMemberOf" />
        <AttributeEncoder xsi:type="oidc:OIDCString" name="edumember_is_member_of" asArray="true" />

          <Template>
           <![CDATA[
                 urn:mace:washington.edu:groups:${memberOf}
             ]]>
          </Template>

    </AttributeDefinition>

 <!-- Course memberships by SLN - this is just for other attributes, not delivered directly -->

    <AttributeDefinition id="sln_courses" xsi:type="Simple" >
        <InputDataConnector ref="courses" attributeNames="memberOf" />
    </AttributeDefinition>


 <!-- static silver assurance -->

    <AttributeDefinition id="assurance" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="eduPersonAssurance" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:eduPersonAssurance" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:1.3.6.1.4.1.5923.1.1.1.11" friendlyName="eduPersonAssurance" />
    </AttributeDefinition>

 <!-- NSC specials -->
    <AttributeDefinition id="nsc_pid" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentID" />
        <AttributeEncoder xsi:type="SAML1String" 
            namespace="http://www.pesc.org/standards/attrs" name="SchoolAssignedPersonID" />
        <AttributeEncoder xsi:type="SAML2String" 
            name="http://www.pesc.org/standards/attrs/SchoolAssignedPersonID" friendlyName="HTTP_SchoolAssignedPersonID" />
    </AttributeDefinition>

    <AttributeDefinition id="nsc_opeid" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="nscOPEID" />
        <AttributeEncoder xsi:type="SAML1String" namespace="http://www.pesc.org/standards/attrs" name="OPEID" />
        <AttributeEncoder xsi:type="SAML2String" name="http://www.pesc.org/standards/attrs/OPEID " friendlyName="HTTP_OPEID" />
    </AttributeDefinition>

    <AttributeDefinition id="nschub_pid" xsi:type="Simple" >
        <InputDataConnector ref="personreg" attributeNames="uwStudentID" />
        <AttributeEncoder xsi:type="SAML2String" name="SchoolAssignedPersonID" />
    </AttributeDefinition>

 <!-- slack idiot specials -->
    <AttributeDefinition id="slack_email" xsi:type="Simple" >
        <InputAttributeDefinition ref="email" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:0.9.2342.19200300.100.1.3" name="User.Email" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_user" xsi:type="Simple" >
        <InputAttributeDefinition ref="uwNetID" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:0.9.2342.19200300.100.1.1" name="User.Username" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_fname" xsi:type="Simple" >
        <InputAttributeDefinition ref="preferredFirst" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:2.5.4.42" name="first_name" />
    </AttributeDefinition>

    <AttributeDefinition id="slack_lname" xsi:type="Simple" >
        <InputAttributeDefinition ref="preferredSurname" />
        <AttributeEncoder xsi:type="SAML2String" friendlyName="urn:oid:2.5.4.4" name="last_name" />
    </AttributeDefinition>

 <!-- Netsuite idiot specials -->
    <AttributeDefinition id="netsuite_account" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="netsuiteAccount" />
        <AttributeEncoder xsi:type="SAML2String" name="account " friendlyName="netsuite_account" />
    </AttributeDefinition>

    <AttributeDefinition id="netsuite_site" xsi:type="Simple" >
        <InputDataConnector ref="staticAttributes" attributeNames="netsuiteSite" />
        <AttributeEncoder xsi:type="SAML2String" name="site " friendlyName="netsuite_site" />
    </AttributeDefinition>

    <!-- ========================================== -->
    <!--      Data Connectors                       -->
    <!-- ========================================== -->


    <!-- Get uwNetID from login -->
    <DataConnector id="loginNetid" xsi:type="ScriptedDataConnector">
        <Script><![CDATA[
           IdPAttribute = Java.type("net.shibboleth.idp.attribute.IdPAttribute");
           StringAttributeValue = Java.type("net.shibboleth.idp.attribute.StringAttributeValue");
           HashSet = Java.type("java.util.HashSet");

           attr = new IdPAttribute("uwNetID");
           set = new HashSet(1);
           set.add(new StringAttributeValue(resolutionContext.getPrincipal()));
           attr.setValues(set);
           connectorResults.add(attr);
        ]]></Script>
    </DataConnector>



    <!-- Static Connector Values-->
    <DataConnector id="staticAttributes" xsi:type="Static" >
        <Attribute id="eduPersonAssurance">
            <Value>http://incommonfederation.org/assurance/silver-test</Value>
        </Attribute>
        <Attribute id="nscOPEID">
            <Value>00379800</Value>
        </Attribute>
        <Attribute id="awsfoxadmin">
            <Value>arn:aws:iam::575779389826:role/UW_dev.admin,arn:aws:iam::575779389826:saml-provider/UW_IdP_dev</Value>
        </Attribute>
        <Attribute id="awstwelve">
            <Value>43200</Value>
        </Attribute>
        <Attribute id="netsuiteAccount">
            <Value>4487126</Value>
        </Attribute>
        <Attribute id="netsuiteSite">
            <Value>3</Value>
        </Attribute>
    </DataConnector>

    <!-- EDS ldap service -->

    <DataConnector id="personreg" xsi:type="LDAPDirectory" 

{% if location == 'uwtc' %}
           ldapURL="ldap://seneca33.s.uw.edu:389 ldap://seneca31.s.uw.edu:389 ldap://seneca32.s.uw.edu:389"
{% elif location == 'ads' %}
           ldapURL="ldap://seneca31.s.uw.edu:389 ldap://seneca33.s.uw.edu:389 ldap://seneca32.s.uw.edu:389"
{% else %}
           ldapURL="ldap://seneca32.s.uw.edu:389 ldap://seneca31.s.uw.edu:389 ldap://seneca33.s.uw.edu:389"
{% endif %}

           baseDN="dc=washington,dc=edu"
           principal="cn=idp.u.washington.edu"
           maxResultSize="10"
           searchTimeLimit="P0Y0M0DT0H0M10.000S"
           useStartTLS="true"
           connectTimeout="PT3S"
           responseTimeout="PT5S"
           trustFile="%{idp.home}/credentials/uw-incommon-ca.crt"
           authCert="%{idp.home}/credentials/idp-uw.crt"
           authKey="%{idp.home}/credentials/idp-uw.key"
           propagateResolutionExceptions="false"
           failFastInitialize="false" 
           >
         <SASLConfig mechanism="EXTERNAL">
         </SASLConfig>
        <FilterTemplate>
            <![CDATA[
               (uwNetID=${resolutionContext.principal})
            ]]>
        </FilterTemplate>
        
        <ConnectionPool
            minPoolSize="0"
            maxPoolSize="6"
            blockWaitTime="PT10S"
            expirationTime="PT10M"
            validatePeriodically="false"
            validateTimerPeriod="PT15M"
            validateDN="dc=washington,dc=edu"
            validateFilter="(ou=People,dc=personregistry)"
            />


    </DataConnector>



 <!-- tgtid (uw method) = eduPersonTargetedID -->

    <!-- Static Connector until idpv3 r/w  bug fixed -->
    <DataConnector id="tgtid2static" xsi:type="Static" >
        <Attribute id="eduPersonTargetedID">
            <Value>1234567890</Value>
        </Attribute>
    </DataConnector>


    <DataConnector id="tgtid2" xsi:type="RelationalDatabase" 
         queryTimeout="PT5S"
         propagateResolutionExceptions="false"
         >
        <InputAttributeDefinition ref="uwRegID" />

        <BeanManagedConnection>EptidDataConnector</BeanManagedConnection>

        <QueryTemplate>
            <![CDATA[
                select tid2('${uwRegID.get(0)}', '${resolutionContext.attributeRecipientID}') as tid
            ]]>
        </QueryTemplate>

        <Column columnName="tid" attributeID="eduPersonTargetedID" />
    </DataConnector>


   <!-- GWS group memberships -->

<DataConnector id="gws" xsi:type="HTTP" 
        httpClientRef="uw.HttpClient"
        httpClientSecurityParametersRef="uw.GwsSecurity" 
        propagateResolutionExceptions="false"
        activationConditionRef="uw.GetsGwsMemberships"
        >
    <URLTemplate>
        <![CDATA[
        https://groups.uw.edu/group_sws/v3/search?member=${resolutionContext.principal}&type=effective
        ]]>
    </URLTemplate>
 
    <ResponseMapping>
        <ScriptFile>%{idp.home}/conf/http-gws.js</ScriptFile>
    </ResponseMapping>
        <ResultCache expireAfterWrite="PT2M"/>
 
</DataConnector>

<DataConnector id="courses" xsi:type="HTTP" 
        httpClientRef="uw.HttpClient"
        httpClientSecurityParametersRef="uw.GwsSecurity" 
        propagateResolutionExceptions="false"
        activationConditionRef="uw.GetsCourseMemberships"
        >
    <URLTemplate>
        <![CDATA[
        https://groups.uw.edu/group_sws/v3/search?stem=course&member=${resolutionContext.principal}&view=sln
        ]]>
    </URLTemplate>
 
    <ResponseMapping>
        <ScriptFile>%{idp.home}/conf/http-gws.js</ScriptFile>
    </ResponseMapping>
        <ResultCache expireAfterWrite="PT5M"/>
 
</DataConnector>

<!--
 Data Connector for generating OIDC 'sub' claim. It may be used to generate both
 public and pairwise subject values because it recognizes the OIDC sector_id
 if used during client registration.
-->
<DataConnector id="computedSubjectId" xsi:type="ComputedId"
	generatedAttributeID="subjectId"
	salt="%{idp.oidc.subject.salt}"
	algorithm="%{idp.oidc.subject.algorithm:SHA}"
	encoding="BASE32">
    <InputAttributeDefinition ref="%{idp.oidc.subject.sourceAttribute}"/>
</DataConnector>

</AttributeResolver>
